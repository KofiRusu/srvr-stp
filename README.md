# ChatOS Server Setup

Docker infrastructure for running ChatOS data scrapers 24/7 on a Linux server.

## One-Command Install

```bash
curl -sSL https://raw.githubusercontent.com/KofiRusu/srvr-stp/main/setup.sh | bash
```

That's it! The script will:
1. Install Docker (if needed)
2. Clone this repository
3. Generate secure credentials
4. Build and start all containers
5. Display your API key for Mac connection

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    LINUX SERVER (Docker)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │  AGGR    │  │ CoinGlass│  │  Market  │   ← Scrapers      │
│  │ Scraper  │  │ Scraper  │  │ Scraper  │     (24/7)        │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘                   │
│       │             │             │                          │
│       └─────────────┼─────────────┘                          │
│                     ▼                                        │
│              ┌──────────────┐                                │
│              │    Redis     │  ← Real-time pub/sub           │
│              │   (cache)    │                                │
│              └──────┬───────┘                                │
│                     │                                        │
│       ┌─────────────┼─────────────┐                          │
│       ▼             ▼             ▼                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │ PostgreSQL│  │ Data API │  │          │                   │
│  │(historical)│  │ :8080   │──┼──────────┼──► Mac Client     │
│  └──────────┘  └──────────┘  │ WebSocket │                   │
│                               └──────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

## Quick Start

### Option 1: One-Command Install (Recommended)

```bash
curl -sSL https://raw.githubusercontent.com/KofiRusu/srvr-stp/main/setup.sh | bash
```

### Option 2: Manual Install

```bash
git clone https://github.com/KofiRusu/srvr-stp.git ~/chatos-server
cd ~/chatos-server
chmod +x setup.sh
./setup.sh
```

### Connect from Mac

Update your Mac's ChatOS to use the remote data feed:

```bash
export CHATOS_DATA_URL="http://your-server-ip:8080"
export CHATOS_API_KEY="your-api-key"
```

## Services

| Service | Port | Description |
|---------|------|-------------|
| PostgreSQL | 5432 | Historical data storage |
| Redis | 6379 | Real-time data cache & pub/sub |
| Data API | 8080 | REST + WebSocket for clients |

## API Endpoints

### REST

- `GET /health` - Health check
- `GET /api/latest/{type}/{symbol}` - Latest data (trades, funding, oi, depth)
- `GET /api/symbols` - List available symbols
- `GET /api/history/{type}/{symbol}?limit=100` - Historical data

### WebSocket

```javascript
// Connect to real-time stream
const ws = new WebSocket('ws://server:8080/ws/stream?api_key=YOUR_KEY&channels=trades:BTCUSDT,funding:BTCUSDT');

ws.onmessage = (event) => {
  const { channel, data } = JSON.parse(event.data);
  console.log(channel, data);
};

// Subscribe to more channels
ws.send(JSON.stringify({ type: 'subscribe', channels: ['oi:ETHUSDT'] }));
```

## Management

```bash
# View logs
docker compose logs -f

# Restart services
docker compose restart

# Stop everything
docker compose down

# Stop and remove data
docker compose down -v

# Update scrapers
docker compose build --no-cache
docker compose up -d
```

## Environment Variables

Create a `.env` file (auto-generated by deploy.sh):

```env
POSTGRES_PASSWORD=secure_password_here
API_KEY=your_api_key_here
```

## Security Notes

1. Change default passwords in `.env`
2. Set up firewall rules to only allow your Mac's IP
3. Consider using a VPN or SSH tunnel for the connection
4. Never commit `.env` to git
